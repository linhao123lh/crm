<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.tfs.crm.workbench.transaction.dao.TransactionDao">

	<!-- 保存交易-->
    <insert id="saveTransaction" parameterType="Transaction">
        insert into tbl_transaction
        (id,owner,amountOfMoney,name,expectedClosingDate,customerId,stage,activityId,contactsId,createBy,createTime)
        values
         (#{id},#{owner},#{amountOfMoney},#{name},#{expectedClosingDate},#{customerId},#{stage},#{activityId},#{contactsId},#{createBy},#{createTime})
    </insert>

    <!-- 保存创建的交易-->
    <insert id="saveCreateTransaction" parameterType="Transaction">
        insert into tbl_transaction
        (id,owner,amountOfMoney,name,expectedClosingDate,customerId,stage,type,source,activityId,
            contactsId,description,createBy,createTime,contactSummary,nextContactTime)
        values
        (#{id},#{owner},#{amountOfMoney},#{name},#{expectedClosingDate},#{customerId},#{stage},#{type},#{source},
          #{activityId},#{contactsId},#{description},#{createBy},#{createTime},#{contactSummary},#{nextContactTime})
    </insert>

    <!-- 根据条件分页查询交易-->
    <select id="queryTransactionForPageByCondition" parameterType="hashmap" resultType="Transaction">
        select t.id,t.name,tcr.name as customerId,t.amountOfMoney,t.expectedClosingDate,dv1.text as stage,dv2.text as type,
                u1.name as owner,dv3.text as source,tma.name as activityId,tcs.fullName as contactsId,u2.name as createBy,
                t.createTime,u3.name as editBy,t.editTime,t.description,t.contactSummary,t.nextContactTime
        from tbl_transaction t
        join tbl_customer tcr on t.customerId = tcr.id
        left join tbl_dictionary_value dv1 on t.stage = dv1.id
        left join tbl_dictionary_value dv2 on t.type = dv2.id
        join tbl_user u1 on t.owner = u1.id
        left join tbl_dictionary_value dv3 on t.source = dv3.id
        left join tbl_marketing_activities tma on t.activityId = tma.id
        left join tbl_contacts tcs on t.contactsId = tcs.id
        join tbl_user u2 on t.createBy = u2.id
        left join tbl_user u3 on t.editBy = u3.id
        <where>
            <if test="owner != null and owner !=''">
                and u1.name like '%' #{owner} '%'
            </if>
            <if test="name != null and name !=''">
                and t.name like '%' #{name} '%'
            </if>
            <if test="amountOfMoney != null and amountOfMoney !=''">
                and t.amountOfMoney = #{amountOfMoney}
            </if>
            <if test="customerName != null and customerName !=''">
                and tcr.name like '%' #{customerName} '%'
            </if>
            <if test="stage != null and stage !=''">
                and t.stage = #{stage}
            </if>
            <if test="type != null and type !=''">
                and t.type =  #{type}
            </if>
            <if test="source != null and source !=''">
                and t.source = #{source}
            </if>
            <if test="contactsName != null and contactsName !=''">
                and tcs.fullName like '%' #{contactsName} '%'
            </if>
        </where>
        order by t.createTime desc
        limit #{beginNo},#{pageSize}
    </select>

    <!-- 根据条件查询交易记录条数-->
    <select id="queryTransactionCountByCondition" parameterType="hashmap" resultType="long">
        select count(*) from tbl_transaction t
        join tbl_customer tcr on t.customerId = tcr.id
        left join tbl_dictionary_value dv1 on t.stage = dv1.id
        left join tbl_dictionary_value dv2 on t.type = dv2.id
        join tbl_user u1 on t.owner = u1.id
        left join tbl_dictionary_value dv3 on t.source = dv3.id
        left join tbl_marketing_activities tma on t.activityId = tma.id
        left join tbl_contacts tcs on t.contactsId = tcs.id
        join tbl_user u2 on t.createBy = u2.id
        left join tbl_user u3 on t.editBy = u3.id
        <where>
            <if test="owner != null and owner !=''">
                and u1.name like '%' #{owner} '%'
            </if>
            <if test="name != null and name !=''">
                and t.name like '%' #{name} '%'
            </if>
            <if test="amountOfMoney != null and amountOfMoney !=''">
                and t.amountOfMoney = #{amountOfMoney}
            </if>
            <if test="customerName != null and customerName !=''">
                and tcr.name like '%' #{customerName} '%'
            </if>
            <if test="stage != null and stage !=''">
                and t.stage = #{stage}
            </if>
            <if test="type != null and type !=''">
                and t.type = #{type}
            </if>
            <if test="source != null and source !=''">
                and t.source = #{source}
            </if>
            <if test="contactsName != null and contactsName !=''">
                and tcs.fullName like '%' #{contactsName} '%'
            </if>
        </where>
    </select>

</mapper>