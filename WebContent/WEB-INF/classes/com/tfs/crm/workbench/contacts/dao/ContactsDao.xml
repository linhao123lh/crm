<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.tfs.crm.workbench.contacts.dao.ContactsDao">

	<!-- 保存创建的联系人-->
	<insert id="saveCreateContacts" parameterType="Contacts">
		insert into tbl_contacts
		(id, owner, source, appellation, fullName, email, job, mphone, description, country, province, city, street, zipcode, birth, customerId, createBy, createTime, contactSummary)
		values
		(#{id},#{owner},#{source},#{appellation},#{fullName},#{email},#{job},#{mphone},#{description},#{country},#{province},#{city},#{street},#{zipcode},#{birth},#{customerId},#{createBy},#{createTime},#{contactSummary})
	</insert>

	<!-- 根据条件分页查询联系人-->
	<select id="queryContactsForPageByCondition" parameterType="hashmap" resultType="Contacts">
		select c.id,u1.name as owner,dv1.text as source,dv2.text as appellation,c.fullName,c.email,c.job,c.mphone,
			c.description,c.country,c.province,c.city,c.street,c.zipcode,c.birth, tc.name as customerId,
			u2.name as createBy,c.createTime,u3.name as editBy,c.editTime,c.contactSummary
		from tbl_contacts c
		join tbl_user u1 on c.owner = u1.id
		left join tbl_dictionary_value dv1 on c.source = dv1.id
		left join tbl_dictionary_value dv2 on c.appellation = dv2.id
		left join tbl_customer tc on c.customerId = tc.id
		join tbl_user u2 on c.createBy = u2.id
		left join tbl_user u3 on c.editBy = u3.id
		<where>
			<if test="owner != null and owner != ''">
				and u1.name like '%' #{owner} '%'
			</if>
			<if test="fullName != null and fullName != ''">
				and c.fullName like '%' #{fullName} '%'
			</if>
			<if test="customerName != null and customerName != ''">
				and tc.name like '%' #{customerName} '%'
			</if>
			<if test="source != null and source != ''">
				and c.source = #{source}
			</if>
			<if test="birth != null and birth != ''">
				and c.birth = #{birth}
			</if>
		</where>
		order by c.createTime desc
		limit #{beginNo},#{pageSize}
	</select>

	<!-- 根据条件查询联系条数 -->
	<select id="queryCountByCondition" parameterType="hashmap" resultType="long">
		select count(*) from tbl_contacts c
		join tbl_user u1 on c.owner = u1.id
		left join tbl_dictionary_value dv1 on c.source = dv1.id
		left join tbl_dictionary_value dv2 on c.appellation = dv2.id
		left join tbl_customer tc on c.customerId = tc.id
		join tbl_user u2 on c.createBy = u2.id
		left join tbl_user u3 on c.editBy = u3.id
		<where>
			<if test="owner != null and owner != ''">
				and u1.name like '%' #{owner} '%'
			</if>
			<if test="fullName != null and fullName != ''">
				and c.fullName like '%' #{fullName} '%'
			</if>
			<if test="customerName != null and customerName != ''">
				and tc.name like '%' #{customerName} '%'
			</if>
			<if test="source != null and source != ''">
				and c.source = #{source}
			</if>
			<if test="birth != null and birth != ''">
				and c.birth = #{birth}
			</if>
		</where>
	</select>

	<!-- 根据线索的名称精准查询联系人信息-->
	<select id="queryContactsByClueFullName" parameterType="string" resultType="Contacts">
		select * from tbl_contacts where fullName = #{fullName}
	</select>
</mapper>